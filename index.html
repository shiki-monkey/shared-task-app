<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Task Reminder</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Your CSS styles go here */
    </style>
</head>
<body>
    <div class="notification-area" id="notificationArea"></div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://dekquvkuhlsokxwhbprs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRla3F1dmt1aGxzb2t4d2hicHJzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODA1MjM5OCwiZXhwIjoyMDczNjI4Mzk4fQ.L68x5i_P-A49FPIe_wtJhScJ-KhfA-NMc9p1mwzTrDs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2b4iCP9YuVYqKEgfmIGbv8VRHdzNwfU4",
            authDomain: "sharedtaskapp-f247e.firebaseapp.com",
            databaseURL: "https://sharedtaskapp-f247e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sharedtaskapp-f247e",
            storageBucket: "sharedtaskapp-f247e.firebasestorage.app",
            messagingSenderId: "912907618302",
            appId: "1:912907618302:web:2d8fda8f7cc89c2e4f22af",
            measurementId: "G-Z89ZKESPBG"
        };

        // Your VAPID key
        const vapidKey = "BHdkIFWbArH408wXGBeB65u3UfbwJw-V2Ol6Por7nq_cV-B-tPehfACaklJeERwJLRL5JQ6yR-7UExH_pgL3DZQ";

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const showRegister = document.getElementById('showRegister');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const currentDaySpan = document.getElementById('currentDay');
        const taskList = document.getElementById('taskList');
        const notificationArea = document.getElementById('notificationArea');
        const dayButtons = document.querySelectorAll('.day-btn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const createTaskBtn = document.getElementById('createTaskBtn');

        // Edit Form Elements
        const editTaskForm = document.getElementById('editTaskForm');
        const editTaskIdInput = document.getElementById('editTaskId');
        const editTaskTitleInput = document.getElementById('editTaskTitle');
        const editTaskDescriptionInput = document.getElementById('editTaskDescription');
        const editTaskDayInput = document.getElementById('editTaskDay');
        const editTaskTimeInput = document.getElementById('editTaskTime');
        const updateTaskBtn = document.getElementById('updateTaskBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        
        let currentUser = null;
        let currentDay = 'monday';
        let tasks = [];

        // Firebase-specific functions and initialization
        const { initializeApp } = window.firebase;
        const { getMessaging, getToken, onMessage } = window.firebase.messaging;

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // This function will get the token and save it to the database
        const saveTokenToDatabase = async () => {
          try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              const token = await getToken(messaging, { vapidKey });
              console.log("FCM Token:", token);

              const { data: { user } } = await supabase.auth.getUser();
              if (!user) {
                console.error("User is not logged in.");
                return;
              }

              // Upsert (insert or update) the token to the 'push_tokens' table
              const { error } = await supabase.from("push_tokens").upsert({
                user_id: user.id,
                token: token,
              });

              if (error) {
                console.error("Error saving token:", error);
              } else {
                console.log("Token saved successfully.");
              }
            } else {
              console.warn("Notification permission denied.");
            }
          } catch (error) {
            console.error("Error getting FCM token:", error);
          }
        };

        // Listen for messages while the app is in the foreground
        onMessage(messaging, (payload) => {
          console.log("Foreground message received:", payload);
          const { title, body } = payload.notification;
          showNotification(title + ': ' + body, 'success');
        });

        // Initialize the app
        async function init() {
          // Check for a logged-in user
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            currentUser = user;
            showApp();
            saveTokenToDatabase(); // Save token for a logged-in user
          } else {
            authContainer.style.display = 'block';
            appContainer.style.display = 'none';
          }

          // Set up event listeners
          loginBtn.addEventListener('click', handleLogin);
          showRegister.addEventListener('click', handleRegister);
          logoutBtn.addEventListener('click', handleLogout);
          createTaskBtn.addEventListener('click', handleCreateTask);
          
          // NEW: Edit and Delete listeners
          taskList.addEventListener('click', (event) => {
              if (event.target.classList.contains('edit-task')) {
                  const taskId = event.target.dataset.id;
                  handleEditTask(taskId);
              } else if (event.target.classList.contains('delete-task')) {
                  const taskId = event.target.dataset.id;
                  deleteTask(taskId);
              }
          });
          
          // NEW: Update and Cancel listeners for the edit form
          editTaskForm.addEventListener('submit', handleUpdateTask);
          cancelEditBtn.addEventListener('click', () => {
              document.getElementById('editTab').classList.remove('active');
              document.getElementById('tasksTab').classList.add('active');
              tabs[0].classList.add('active'); // Activate the Tasks tab
              tabs[1].classList.remove('active'); // Deactivate Create Task tab
          });
          
          dayButtons.forEach(btn => {
              btn.addEventListener('click', () => {
                  currentDay = btn.dataset.day;
                  currentDaySpan.textContent = capitalizeFirstLetter(currentDay);

                  // Update active button
                  dayButtons.forEach(b => b.classList.remove('active'));
                  btn.classList.add('active');

                  fetchAndRenderTasks();
              });
          });

          tabs.forEach(tab => {
              tab.addEventListener('click', () => {
                  const tabId = tab.dataset.tab;

                  // Update active tab
                  tabs.forEach(t => t.classList.remove('active'));
                  tab.classList.add('active');

                  // Show corresponding content
                  tabContents.forEach(content => content.classList.remove('active'));
                  document.getElementById(`${tabId}Tab`).classList.add('active');
              });
          });

          // Check for reminders every minute
          setInterval(checkReminders, 60000);
        }

        // Authentication functions
        async function handleLogin() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          const { data, error } = await supabase.auth.signInWithPassword({ email, password });

          if (error) {
            showNotification(error.message, 'error');
          } else {
            currentUser = data.user;
            showNotification('Login successful!', 'success');
            showApp();
            saveTokenToDatabase(); // Save token on successful login
          }
        }

        async function handleRegister() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          const { data, error } = await supabase.auth.signUp({ email, password });

          if (error) {
            showNotification(error.message, 'error');
          } else {
            currentUser = data.user;
            showNotification('Registration successful! Please check your email to confirm.', 'success');
          }
        }

        async function handleLogout() {
          const { error } = await supabase.auth.signOut();

          if (error) {
            showNotification('Error logging out: ' + error.message, 'error');
          } else {
            showNotification('Logged out successfully', 'success');
            window.location.reload(); // Reloads the page to show the login screen
          }
        }

        function showApp() {
          authContainer.style.display = 'none';
          appContainer.style.display = 'block';
          currentUserSpan.textContent = currentUser.email;
          fetchAndRenderTasks();
        }

        // Task creation
        async function handleCreateTask() {
          const title = document.getElementById('taskTitle').value;
          const description = document.getElementById('taskDescription').value;
          const day = document.getElementById('taskDay').value;
          const time = document.getElementById('taskTime').value;

          if (!title || !time) {
            showNotification('Please fill in all required fields', 'error');
            return;
          }

          const { data, error } = await supabase
            .from('tasks')
            .insert([{
              title: title,
              description: description,
              day: day,
              time: time,
              is_completed: false,
              user_id: currentUser.id,
              user_email: currentUser.email
            }]);

          if (error) {
            showNotification('Error creating task: ' + error.message, 'error');
          } else {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskTime').value = '';

            showNotification('Task created successfully!', 'success');
          }
        }

        // Task completion
        async function toggleTaskCompletion(taskId, completed) {
          const { data, error } = await supabase
            .from('tasks')
            .update({
              is_completed: completed,
              completed_by: completed ? currentUser.email : null,
              completed_at: completed ? new Date().toISOString() : null
            })
            .eq('id', taskId);

          if (error) {
            showNotification('Error updating task: ' + error.message, 'error');
          } else {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
              showNotification(`Task completed: ${task.title} by ${currentUser.email}`, 'success');
            }
          }
        }

        // Task Editing
        async function handleEditTask(taskId) {
          const { data: task, error } = await supabase
            .from('tasks')
            .select('*')
            .eq('id', taskId)
            .single();
          
          if (error) {
            showNotification('Error fetching task for editing: ' + error.message, 'error');
            return;
          }
          
          document.getElementById('editTab').classList.add('active');
          document.getElementById('tasksTab').classList.remove('active');
          document.querySelector('.tab[data-tab="tasks"]').classList.remove('active');
          
          editTaskIdInput.value = task.id;
          editTaskTitleInput.value = task.title;
          editTaskDescriptionInput.value = task.description;
          editTaskDayInput.value = task.day;
          editTaskTimeInput.value = task.time;
        }

        // Task Update
        async function handleUpdateTask(event) {
          event.preventDefault();
          const taskId = editTaskIdInput.value;
          
          const updatedTask = {
            title: editTaskTitleInput.value,
            description: editTaskDescriptionInput.value,
            day: editTaskDayInput.value,
            time: editTaskTimeInput.value,
          };
          
          const { error } = await supabase
            .from('tasks')
            .update(updatedTask)
            .eq('id', taskId);
            
          if (error) {
            showNotification('Error updating task: ' + error.message, 'error');
          } else {
            showNotification('Task updated successfully!', 'success');
            document.getElementById('editTab').classList.remove('active');
            document.getElementById('tasksTab').classList.add('active');
            document.querySelector('.tab[data-tab="tasks"]').classList.add('active');
            fetchAndRenderTasks();
          }
        }

        // Task deletion
        async function deleteTask(taskId) {
          if (confirm('Are you sure you want to delete this task?')) {
            const { data, error } = await supabase
              .from('tasks')
              .delete()
              .eq('id', taskId);
              
            if (error) {
              showNotification('Error deleting task: ' + error.message, 'error');
            } else {
              showNotification('Task deleted successfully', 'success');
            }
          }
        }

        // Task rendering
        function renderTasks() {
          const dayTasks = tasks.filter(task => task.day === currentDay);

          if (dayTasks.length === 0) {
            taskList.innerHTML = '<p>No tasks for this day.</p>';
            return;
          }

          taskList.innerHTML = '';

          dayTasks.forEach(task => {
            const taskCard = document.createElement('div');
            taskCard.className = `task-card ${task.is_completed ? 'completed' : ''}`;

            taskCard.innerHTML = `
              <div class="task-header">
                <div class="task-title">${task.title}</div>
                <div class="task-time">${formatTime(task.time)}</div>
              </div>
              <div class="task-description">${task.description || ''}</div>
              <div class="task-completion">
                <input type="checkbox" id="task-${task.id}" ${task.is_completed ? 'checked' : ''}>
                <label for="task-${task.id}">${task.is_completed ? 'Completed' : 'Mark as completed'}</label>
              </div>
              ${task.is_completed ? `
                <div class="completed-by">
                  Completed by ${task.completed_by} at ${formatDateTime(task.completed_at)}
                </div>
              ` : ''}
              <div class="task-actions">
                <button class="edit-task" data-id="${task.id}">Edit Task</button>
                <button class="delete-task" data-id="${task.id}">Delete Task</button>
              </div>
            `;
            
            const checkbox = taskCard.querySelector(`#task-${task.id}`);
            checkbox.addEventListener('change', () => {
              toggleTaskCompletion(task.id, checkbox.checked);
            });

            taskList.appendChild(taskCard);
          });
        }
        
        // Fetch tasks with real-time updates
        async function fetchAndRenderTasks() {
          supabase.removeAllChannels();

          supabase
            .channel('realtime_tasks')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => {
              fetchTasks();
            })
            .subscribe();

          fetchTasks();
        }

        async function fetchTasks() {
          const { data, error } = await supabase
            .from('tasks')
            .select('*');

          if (error) {
            console.error('Error fetching tasks:', error.message);
            showNotification('Error fetching tasks.', 'error');
          } else {
            tasks = data;
            renderTasks();
          }
        }

        // Reminder system
        function checkReminders() {
          const now = new Date();
          const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
          const day = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][now.getDay()];

          tasks.forEach(task => {
            if (task.day === day && task.time === currentTime && !task.is_completed) {
              showNotification(`Reminder: It's time to ${task.title}`, 'success');
            }
          });
        }

        // Helper functions
        function showNotification(message, type = 'success') {
          const notification = document.createElement('div');
          notification.className = `notification ${type === 'error' ? 'error' : ''}`;
          notification.textContent = message;

          notificationArea.appendChild(notification);

          setTimeout(() => {
            notification.remove();
          }, 5000);
        }

        function formatTime(timeStr) {
          if (!timeStr) return '';

          const [hours, minutes] = timeStr.split(':');
          const hour = parseInt(hours);
          const ampm = hour >= 12 ? 'PM' : 'AM';
          const formattedHour = hour % 12 || 12;

          return `${formattedHour}:${minutes.padStart(2, '0')} ${ampm}`;
        }

        function formatDateTime(timestamp) {
          if (!timestamp) return '';

          const date = new Date(timestamp);
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function capitalizeFirstLetter(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
